<script lang="ts">
	import { onMount, tick } from 'svelte';
	import { browser } from '$app/environment';
	import Button from '$lib/components/common/Button.svelte';
	import Card from '$lib/components/common/Card.svelte';
	import ThemeToggle from '$lib/components/common/ThemeToggle.svelte';
	import ChatHeader from '$lib/components/maice/ChatHeader.svelte';
	import MessageList from '$lib/components/maice/MessageList.svelte';
	import MessageInput from '$lib/components/maice/MessageInput.svelte';
	import SessionManager from '$lib/components/maice/SessionManager.svelte';
	import { themeStore } from '$lib/stores/theme';
	import { authStore } from '$lib/stores/auth';
	import { goto } from '$app/navigation';
	import { sendMAICEMessage, type MAICEChatRequest, submitQuestionStream } from '$lib/api';
	
	let currentTheme = 'auto';
	let isDark = false;
	let authToken = '';
	let isAuthenticated = false;
	let user = $state<any>(null);
	
	// í…Œë§ˆ ìƒíƒœ êµ¬ë…
	themeStore.subscribe(state => {
		currentTheme = state.current;
		isDark = state.isDark;
	});
	
	// ì¸ì¦ ìƒíƒœ êµ¬ë… (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œë§Œ)
	if (browser) {
		authStore.subscribe(state => {
			authToken = state.user?.access_token || '';
			isAuthenticated = state.isAuthenticated;
			user = state.user;
		});
	}
	
	// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
	$effect(() => {
		if (isAuthenticated) {
			console.log('âœ… ì¸ì¦ëœ ì‚¬ìš©ì:', user?.username, 'ì—­í• :', user?.role);
			console.log('ğŸ”‘ ì¸ì¦ í† í°:', authToken);
		}
	});
	

	
	// ì±„íŒ… ê´€ë ¨ ìƒíƒœ
	let messages: Array<{
		id: number;
		type: 'user' | 'ai';
		content: string;
		timestamp: string;
		isClarification?: boolean;
	}> = $state([
		{
			id: 1,
			type: 'ai' as const,
			content: 'ì•ˆë…•í•˜ì„¸ìš”! MAICE AI í•™ìŠµ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ê³ ë“±í•™êµ ìˆ˜í•™ í•™ìŠµì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ğŸ“š\n\n## **ìˆ˜í•™ í•™ìŠµ ì˜ˆì‹œ:**\n\n### ì´ì°¨ë°©ì •ì‹\n`$x^2 + 2x + 1 = 0$`ì˜ í•´ë¥¼ êµ¬í•´ì£¼ì„¸ìš”\n\n### ë¯¸ë¶„\n`$f(x) = x^2$`ì˜ ë„í•¨ìˆ˜ë¥¼ êµ¬í•´ì£¼ì„¸ìš”\n\n### ì ë¶„\n`$\\int x^2 dx$`ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”\n\n### ì‚¼ê°í•¨ìˆ˜\n`$\\sin(30Â°)$`ì˜ ê°’ì„ êµ¬í•´ì£¼ì„¸ìš”\n\n## **ê°œë… ì„¤ëª…ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤:**\n\n> ì´ì°¨í•¨ìˆ˜ì˜ ê·¸ë˜í”„ê°€ ì–´ë–»ê²Œ ê·¸ë ¤ì§€ëŠ”ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”\n> ë¯¸ë¶„ì˜ ê¸°í•˜í•™ì  ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?\n> ì ë¶„ê³¼ ë¯¸ë¶„ì˜ ê´€ê³„ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”\n\n### **ì§€ì›í•˜ëŠ” ê¸°ëŠ¥:**\n- **ìˆ˜ì‹ ë Œë”ë§**: LaTeX ìˆ˜ì‹ ì™„ë²½ ì§€ì›\n- **ë§ˆí¬ë‹¤ìš´**: ì œëª©, ê°•ì¡°, ì½”ë“œ ë¸”ë¡ ë“±\n- **ì‹¤ì‹œê°„ ì‘ë‹µ**: ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ì˜ ë‹µë³€\n\nê³ ë“±í•™êµ ìˆ˜í•™ì˜ ëª¨ë“  ì˜ì—­ì„ ë„ì™€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ¯',
			timestamp: new Date().toLocaleTimeString()
		}
	]);

	// ë‹µë³€ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ ìƒíƒœ
	let isAnswerCompleted = $state(false);

	// ë©”ì‹œì§€ ë°°ì—´ ë³€ê²½ ê°ì§€
	$effect(() => {
		console.log('ğŸ”„ ë©”ì‹œì§€ ë°°ì—´ ë³€ê²½ë¨:', messages.length, 'ê°œ');
		console.log('ğŸ“ ìµœì‹  ë©”ì‹œì§€:', $inspect(messages[messages.length - 1]));
	});

	let isLoading = $state(false);
	let sessionId = $state<number | null>(null);
	let requestId = $state<string | null>(null);
	let messageInputRef: any = null;
	
	// ëª…ë£Œí™” ê´€ë ¨ ìƒíƒœ (ë‹¨ìˆœí™”)
	let currentClarificationField = $state<string | null>(null);
	
	// ì„¸ì…˜ ê´€ë¦¬ ì‚¬ì´ë“œë°” ìƒíƒœ
	let isSessionSidebarOpen = $state(false);
	
	// isLoading ìƒíƒœ ë³€ê²½ ê°ì§€
	$effect(() => {
		console.log('ğŸ”„ isLoading ìƒíƒœ ë³€ê²½ë¨:', $inspect(isLoading));
	});

	// ëª…ë£Œí™” í•„ë“œ ìƒíƒœ ë³€ê²½ ê°ì§€
	$effect(() => {
		console.log('ğŸ”„ ëª…ë£Œí™” í•„ë“œ ìƒíƒœ ë³€ê²½ë¨:', $inspect(currentClarificationField));
		
		// ë¡œë”© ì¤‘ì´ ì•„ë‹ ë•Œ ì…ë ¥ í•„ë“œ í™œì„±í™”
		if (!isLoading && messageInputRef) {
			setTimeout(() => {
				if (messageInputRef && typeof messageInputRef.focus === 'function') {
					messageInputRef.focus();
				}
			}, 100);
		}
	});
	
	// ë©”ì‹œì§€ ì…ë ¥ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
	function handleMessageInput(event: CustomEvent) {
		console.log('ğŸ“ ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸: input ì´ë²¤íŠ¸ ìˆ˜ì‹ ë¨');
		console.log('ğŸ“‹ ì´ë²¤íŠ¸ ìƒì„¸:', event.detail);
		console.log('ğŸ“‹ ì´ë²¤íŠ¸ íƒ€ì…:', event.type);
		console.log('ğŸ“‹ ì´ë²¤íŠ¸ íƒ€ê²Ÿ:', event.target);
	}
	
	// ì„¸ì…˜ ê´€ë ¨ í•¨ìˆ˜ë“¤
	function handleSessionSelect(sessionId: number) {
		sessionId = sessionId;
		isSessionSidebarOpen = false; // ì‚¬ì´ë“œë°” ë‹«ê¸°
		console.log('ğŸ”— ì„¸ì…˜ ì„ íƒë¨:', sessionId);
	}
	
	function handleNewSession() {
		sessionId = null;
		messages = [
			{
				id: 1,
				type: 'ai' as const,
				content: 'ì•ˆë…•í•˜ì„¸ìš”! MAICE AI í•™ìŠµ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ê³ ë“±í•™êµ ìˆ˜í•™ í•™ìŠµì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ğŸ“š\n\n**ìˆ˜í•™ í•™ìŠµ ì˜ˆì‹œ:**\n- **ì´ì°¨ë°©ì •ì‹**: `$x^2 + 2x + 1 = 0$`ì˜ í•´ë¥¼ êµ¬í•´ì£¼ì„¸ìš”\n- **ë¯¸ë¶„**: `$f(x) = x^2$`ì˜ ë„í•¨ìˆ˜ë¥¼ êµ¬í•´ì£¼ì„¸ìš”\n- **ì ë¶„**: `$\\int x^2 dx$`ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”\n- **ì‚¼ê°í•¨ìˆ˜**: `$\\sin(30Â°)$`ì˜ ê°’ì„ êµ¬í•´ì£¼ì„¸ìš”\n\n**ê°œë… ì„¤ëª…ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤:**\n- ì´ì°¨í•¨ìˆ˜ì˜ ê·¸ë˜í”„ê°€ ì–´ë–»ê²Œ ê·¸ë ¤ì§€ëŠ”ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”\n- ë¯¸ë¶„ì˜ ê¸°í•˜í•™ì  ì˜ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?\n- ì ë¶„ê³¼ ë¯¸ë¶„ì˜ ê´€ê³„ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”\n\nê³ ë“±í•™êµ ìˆ˜í•™ì˜ ëª¨ë“  ì˜ì—­ì„ ë„ì™€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ¯',
				timestamp: new Date().toLocaleTimeString()
			}
		];
		currentClarificationField = null;
		console.log('ğŸ†• ìƒˆ ì„¸ì…˜ ìƒì„±ë¨');
	}
	
	// ë©”ì‹œì§€ ì „ì†¡ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
	async function handleMessageSend(event: CustomEvent) {
		console.log('ğŸš€ ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸: send ì´ë²¤íŠ¸ ìˆ˜ì‹ ë¨');
		console.log('ğŸ“‹ ì´ë²¤íŠ¸ ìƒì„¸:', event.detail);
		console.log('ğŸ“‹ ì´ë²¤íŠ¸ íƒ€ì…:', event.type);
		console.log('ğŸ“‹ ì´ë²¤íŠ¸ íƒ€ê²Ÿ:', event.target);
		
		const message = event.detail.message;
		console.log('ğŸš€ ë©”ì‹œì§€ ì „ì†¡ ì‹œì‘:', message);
		
		if (!message.trim()) {
			console.warn('âš ï¸ ë¹ˆ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„');
			return;
		}
		
		// ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
		const userMessage = {
			id: messages.length + 1,
			type: 'user' as const,
			content: message,
			timestamp: new Date().toLocaleTimeString()
		};
		
		console.log('ğŸ‘¤ ì‚¬ìš©ì ë©”ì‹œì§€ ìƒì„±:', userMessage);
		
		// ë°°ì—´ ì—…ë°ì´íŠ¸ - ë°˜ì‘ì„± ë³´ì¥
		messages = [...messages, userMessage];
		console.log('ğŸ“ ë©”ì‹œì§€ ë°°ì—´ ì—…ë°ì´íŠ¸ë¨, ì´ ê°œìˆ˜:', messages.length);
		console.log('ğŸ“‹ í˜„ì¬ ë©”ì‹œì§€ ë°°ì—´:', messages);
		
		isLoading = true;
		
		try {
			console.log('ğŸš€ SSE ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘...');
			console.log('ğŸ”‘ ì¸ì¦ í† í°:', authToken ? 'ìˆìŒ' : 'ì—†ìŒ');
			console.log('ğŸ“ ì§ˆë¬¸:', message);
			console.log('ğŸ†” ì„¸ì…˜ ID:', sessionId);
			
			// SSE ìŠ¤íŠ¸ë¦¬ë°ì„ ì‚¬ìš©í•˜ì—¬ ì§ˆë¬¸ ì²˜ë¦¬
			// í˜„ì¬ ì„¸ì…˜ IDì™€ ìš”ì²­ ID ì‚¬ìš©
			const currentSessionId = sessionId || undefined;
			const currentRequestId = requestId || undefined;
			
			console.log('ğŸš€ ì§ˆë¬¸ ì²˜ë¦¬ ì‹œì‘:', {
				currentSessionId,
				currentRequestId,
				originalSessionId: sessionId,
				originalRequestId: requestId
			});
			
			// ë©”ì‹œì§€ íƒ€ì… ì„¤ì • (ëª…ë£Œí™” í•„ë“œê°€ ìˆìœ¼ë©´ ëª…ë£Œí™” ì‘ë‹µ)
			const messageType = currentClarificationField ? 'clarification_response' : 'question';
			
			await submitQuestionStream(
				authToken,
				message,
				currentSessionId,
				messageType,  // ë©”ì‹œì§€ íƒ€ì… ì „ë‹¬
				// ë©”ì‹œì§€ ìˆ˜ì‹  ì½œë°±
				(data) => {
					console.log('ğŸ“¨ SSE ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
					console.log('ğŸ“Š ë©”ì‹œì§€ íƒ€ì…:', data.type);
					console.log('ğŸ“Š ë©”ì‹œì§€ ìƒíƒœ:', data.status);
					console.log('ğŸ“Š ë©”ì‹œì§€ ë‚´ìš©:', data);
					console.log('ğŸ” session_id í™•ì¸:', data.session_id, 'íƒ€ì…:', typeof data.session_id);
					console.log('ğŸ” request_id í™•ì¸:', data.request_id, 'íƒ€ì…:', typeof data.request_id);
					
					// ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬ (ë‹¨ìˆœí™”)
					if (data.type === 'connected') {
						// ì—°ê²° ë©”ì‹œì§€
						console.log('ğŸ”— ì—°ê²°ë¨:', data);
						
						// session_idì™€ request_id ì €ì¥
						if (data.session_id !== undefined && data.session_id !== null) {
							sessionId = data.session_id;
							console.log('âœ… ì„¸ì…˜ ID ì €ì¥:', sessionId);
						}
						if (data.request_id) {
							requestId = data.request_id;
							console.log('âœ… ìš”ì²­ ID ì €ì¥:', requestId);
						}
						
						console.log('âœ… ì—°ê²° ì •ë³´ ì €ì¥ ì™„ë£Œ:', { sessionId, requestId });
						
					} else if (data.type === 'clarification_question') {
						// ëª…ë£Œí™” ì§ˆë¬¸ ë©”ì‹œì§€ ì²˜ë¦¬
						console.log('ğŸ” ëª…ë£Œí™” ì§ˆë¬¸ ìˆ˜ì‹ :', data);
						
						// ëª…ë£Œí™” ì§ˆë¬¸ì˜ request_idì™€ session_id ì €ì¥
						if (data.request_id) {
							requestId = data.request_id;
							console.log('ğŸ”— ëª…ë£Œí™” ì§ˆë¬¸ request_id ì €ì¥:', requestId);
						}
						if (data.session_id !== undefined && data.session_id !== null) {
							sessionId = data.session_id;
							console.log('ğŸ”— ëª…ë£Œí™” ì§ˆë¬¸ session_id ì €ì¥:', sessionId);
						}
						
						// ì§ˆë¬¸ ë‚´ìš©ì„ í‘œì‹œ
						const questionContent = data.message || 'ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.';
						
						const clarificationMessage = {
							id: messages.length + 1,
							type: 'ai' as const,
							content: questionContent,
							timestamp: new Date().toLocaleTimeString()
						};
						
						messages = [...messages, clarificationMessage];
						console.log('ğŸ“ ëª…ë£Œí™” ì§ˆë¬¸ ë©”ì‹œì§€ ì¶”ê°€ë¨:', clarificationMessage);
						
						// ëª…ë£Œí™” ì§ˆë¬¸ í›„ ë¡œë”© ìƒíƒœ í•´ì œ
						isLoading = false;
						
					} else if (data.type === 'answer_chunk') {
						// ë‹µë³€ ì²­í¬ ë©”ì‹œì§€ ì²˜ë¦¬
						console.log('ğŸ“ ë‹µë³€ ì²­í¬ ìˆ˜ì‹ :', data);
						
						// ê¸°ì¡´ AI ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—…ë°ì´íŠ¸
						let existingMessage = messages.find(m => m.type === 'ai' && (m as any).isStreaming);
						
						if (!existingMessage) {
							// ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ìƒì„±
							existingMessage = {
								id: messages.length + 1,
								type: 'ai' as const,
								content: '',
								timestamp: new Date().toLocaleTimeString()
							};
							(existingMessage as any).isStreaming = true;
							messages = [...messages, existingMessage];
						}
						
						// ì²­í¬ ë‚´ìš©ì„ ê¸°ì¡´ ë©”ì‹œì§€ì— ì¶”ê°€
						existingMessage.content += data.chunk + '\n';
						
						// ë©”ì‹œì§€ ë°°ì—´ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
						messages = [...messages];
						
					} else if (data.type === 'answer_complete') {
						// ë‹µë³€ ì™„ë£Œ ë©”ì‹œì§€
						console.log('âœ… ë‹µë³€ ì™„ë£Œ:', data);
						
						// ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ì˜ ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ í•´ì œ
						const streamingMessage = messages.find(m => m.type === 'ai' && (m as any).isStreaming);
						if (streamingMessage) {
							(streamingMessage as any).isStreaming = false;
							messages = [...messages];
						}
						
						// ë¡œë”© ìƒíƒœ í•´ì œ
						isLoading = false;
						
					} else if (data.type === 'processing') {
						// ì²˜ë¦¬ ì¤‘ ë©”ì‹œì§€
						console.log('â³ ì²˜ë¦¬ ì¤‘:', data.message);
						
					} else if (data.message) {
						// ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬
						const aiResponse = {
							id: messages.length + 1,
							type: 'ai' as const,
							content: data.message,
							timestamp: new Date().toLocaleTimeString()
						};
						
						messages = [...messages, aiResponse];
						console.log('ğŸ“ AI ì‘ë‹µ ë©”ì‹œì§€ ì¶”ê°€ë¨:', aiResponse);
						
						// ë¡œë”© ìƒíƒœ í•´ì œ
						isLoading = false;
							console.log('ğŸ“ ëª…ë£Œí™” ë©”ì‹œì§€ ì¶”ê°€ë¨:', clarificationMessage);
							
							// ëª…ë£Œí™” ì§ˆë¬¸ í›„ ë¡œë”© ìƒíƒœ í•´ì œ
							isLoading = false;
						}
						
						// complete ì´ë²¤íŠ¸ì—ì„œëŠ” ë‹µë³€ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ (ì¤‘ë³µ ë°©ì§€)
						else if (data.assistant_markdown) {
							console.log('âš ï¸ complete ì´ë²¤íŠ¸ì—ì„œ assistant_markdown ë°œê²¬, ì¤‘ë³µ ë°©ì§€ë¡œ ì¶”ê°€í•˜ì§€ ì•ŠìŒ');
							
							// ë¡œë”© ìƒíƒœë§Œ í•´ì œ
							isLoading = false;
							isClarificationMode = false;
							currentClarificationRequest = null;
						}
						
						// ì•„ë¬´ê²ƒë„ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ë©”ì‹œì§€
						else {
							console.log('âš ï¸ ì™„ë£Œë˜ì—ˆì§€ë§Œ ë‚´ìš©ì´ ì—†ìŒ');
							const defaultMessage = {
								id: messages.length + 1,
								type: 'ai' as const,
								content: 'ì§ˆë¬¸ì„ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤. ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
								timestamp: new Date().toLocaleTimeString()
							};
							
							messages = [...messages, defaultMessage];
							
							// ê¸°ë³¸ ë©”ì‹œì§€ í›„ ë¡œë”© ìƒíƒœ í•´ì œ
							isLoading = false;
						}
						
					} else {
						// ê¸°íƒ€ ë©”ì‹œì§€
						console.log('ğŸ“¨ ê¸°íƒ€ ë©”ì‹œì§€:', data);
					}
				},
				// ì—ëŸ¬ ì½œë°±
				(error) => {
					console.error('âŒ SSE ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜:', error);
					const errorMessage = {
						id: messages.length + 1,
						type: 'ai' as const,
						content: `âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`,
						timestamp: new Date().toLocaleTimeString()
					};
					messages = [...messages, errorMessage];
					
					// ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œë”© ìƒíƒœ í•´ì œ ë° ëª…ë£Œí™” ëª¨ë“œ ì¢…ë£Œ
					isLoading = false;
					isClarificationMode = false;
					currentClarificationRequest = null;
				},
				// ì™„ë£Œ ì½œë°±
				() => {
					console.log('âœ… SSE ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ');
					
					// ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ ë¡œë”© ìƒíƒœ í•´ì œ
					isLoading = false;
					
					// ëª…ë£Œí™” ëª¨ë“œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ëª…ë£Œí™” ëª¨ë“œ ì¢…ë£Œ
					// (ëª…ë£Œí™” ì§ˆë¬¸ì´ ìˆëŠ” ê²½ìš°ëŠ” ìœ ì§€)
					if (!currentClarificationRequest) {
						isClarificationMode = false;
					}
				}
			);
			
			console.log('âœ… SSE ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ ì™„ë£Œ');
			
		} catch (error) {
			console.error('ğŸ’¥ ì§ˆë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
			const errorMessage = {
				id: messages.length + 1,
				type: 'ai' as const,
				content: `âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error instanceof Error ? error.message : String(error)}`,
				timestamp: new Date().toLocaleTimeString()
			};
			messages = [...messages, errorMessage];
			
			// ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œë”© ìƒíƒœ í•´ì œ ë° ëª…ë£Œí™” ëª¨ë“œ ì¢…ë£Œ
			isLoading = false;
			isClarificationMode = false;
			currentClarificationRequest = null;
		}
	}
	
	function handleBackToDashboard() {
		goto('/dashboard');
	}
	
	function handleClearChat() {
		console.log('ğŸ”„ ìƒˆ ëŒ€í™” ì‹œì‘');
		
		// ì„¸ì…˜ ë° ìš”ì²­ ID ì´ˆê¸°í™”
		sessionId = null;
		requestId = null;
		
		// ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
		if (messageInputRef && typeof messageInputRef.clear === 'function') {
			messageInputRef.clear();
		}
		
		// ëª…ë£Œí™” ëª¨ë“œ ì¢…ë£Œ
		isClarificationMode = false;
		currentClarificationRequest = null;
		
		messages = [
			{
				id: 1,
				type: 'ai' as const,
				content: 'ì•ˆë…•í•˜ì„¸ìš”! MAICE AI í•™ìŠµ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?\n\n**ì‚¬ìš© ì˜ˆì‹œ:**\n- ìˆ˜í•™ ë¬¸ì œ: `$x^2 + 2x + 1 = 0$`ì˜ í•´ë¥¼ êµ¬í•´ì£¼ì„¸ìš”\n- ë¬¼ë¦¬ ê³µì‹: `$$E = mc^2$$`ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”\n- ì½”ë“œ ì„¤ëª…: ```python\nprint("Hello, World!")\n```\n\në§ˆí¬ë‹¤ìš´ê³¼ LaTeX ìˆ˜ì‹ì„ ëª¨ë‘ ì§€ì›í•©ë‹ˆë‹¤! ğŸ“šâœ¨',
				timestamp: new Date().toLocaleTimeString()
			}
		];
	}
</script>

<svelte:head>
	<title>MAICE AI í•™ìŠµ ë„ìš°ë¯¸ - MAICE</title>
</svelte:head>

<div class="maice-page">
	<!-- í—¤ë” -->
	<header class="maice-header">
		<div class="maice-container">
			<div class="maice-header-left">
				<Button variant="ghost" size="sm" on:click={handleBackToDashboard}>
					â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
				</Button>
				<h1 class="maice-title">MAICE AI í•™ìŠµ ë„ìš°ë¯¸</h1>
			</div>
			<div class="maice-header-right">
				<Button 
					variant="ghost" 
					size="sm" 
					on:click={() => isSessionSidebarOpen = !isSessionSidebarOpen}
				>
					{isSessionSidebarOpen ? 'ğŸ“‹' : 'ğŸ’¬'} ì„¸ì…˜ ê´€ë¦¬
				</Button>
				{#if user}
					<span class="maice-user-info">
						ì•ˆë…•í•˜ì„¸ìš”, <span class="maice-username">{user.username}</span>ë‹˜
					</span>
				{/if}
				<Button variant="ghost" size="sm" on:click={() => goto('/')}>
					ë¡œê·¸ì•„ì›ƒ
				</Button>
				<ThemeToggle />
			</div>
		</div>
	</header>

	<!-- ë©”ì¸ ì½˜í…ì¸  -->
	<main class="maice-main">
		<div class="maice-container">
			<!-- ì„¸ì…˜ ê´€ë¦¬ ì‚¬ì´ë“œë°” -->
			{#if isSessionSidebarOpen}
				<div class="maice-session-sidebar">
					<Card variant="elevated" animation="slide-up" className="maice-session-card">
						<SessionManager
							{authToken}
							currentSessionId={sessionId}
							onSessionSelect={handleSessionSelect}
							onNewSession={handleNewSession}
						/>
					</Card>
				</div>
			{/if}
			
			<!-- ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ -->
			<Card variant="elevated" animation="fade-in" className="maice-chat-container">
				<ChatHeader 
					{sessionId} 
					{requestId} 
					onClearChat={handleClearChat} 
				/>
				
				<!-- ì„¸ì…˜ ì •ë³´ í‘œì‹œ -->
				<div class="maice-session-info">
					<div class="maice-session-item">
						<span class="maice-session-label">ì„¸ì…˜ ID:</span>
						<span class="maice-session-value">
							{#if sessionId}
								{sessionId}
							{:else}
								<span class="maice-session-null">ì—†ìŒ</span>
							{/if}
						</span>
					</div>
					<div class="maice-session-item">
						<span class="maice-session-label">ìš”ì²­ ID:</span>
						<span class="maice-session-value">
							{#if requestId}
								{requestId.slice(0, 8)}...
							{:else}
								<span class="maice-session-null">ì—†ìŒ</span>
							{/if}
						</span>
					</div>
					<div class="maice-session-item">
						<span class="maice-session-label">ëª…ë£Œí™” ëª¨ë“œ:</span>
						<span class="maice-session-value">
							{#if isClarificationMode}
								<span class="maice-session-active">í™œì„±</span>
							{:else}
								<span class="maice-session-inactive">ë¹„í™œì„±</span>
							{/if}
						</span>
					</div>
				</div>
				
				<!-- ë©”ì‹œì§€ ëª©ë¡ -->
				<MessageList {messages} {isLoading} />
				
				<!-- ë©”ì‹œì§€ ì…ë ¥ -->
				<MessageInput
					placeholder={isClarificationMode ? "ëª…ë£Œí™” ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”..." : "ìˆ˜í•™ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (LaTeX ìˆ˜ì‹ ì§€ì›: $x^2 + 1$)"}
					disabled={isLoading}
					isClarificationMode={isClarificationMode}
					{isLoading}
					on:input={handleMessageInput}
					on:send={handleMessageSend}
					bind:this={messageInputRef}
				/>
			</Card>

			<!-- ì‚¬ìš© íŒ -->
			<Card variant="default" animation="slide-up" className="maice-tips">
				<h3>ğŸ’¡ ì‚¬ìš© íŒ</h3>
				<div class="maice-tips-grid">
					<div class="maice-tip">
						<h4>ğŸ“š í•™ìŠµ ì§ˆë¬¸</h4>
						<p>"ìˆ˜í•™ ë¬¸ì œë¥¼ í’€ì–´ì£¼ì„¸ìš”", "ì˜ì–´ ë¬¸ë²•ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”"</p>
					</div>
					<div class="maice-tip">
						<h4>ğŸ” ê°œë… ì„¤ëª…</h4>
						<p>"ì–‘ìì—­í•™ì´ ë­”ê°€ìš”?", "ì¸ê³µì§€ëŠ¥ì˜ ì›ë¦¬ëŠ”?"</p>
					</div>
					<div class="maice-tip">
						<h4>âœï¸ ê³¼ì œ ë„ì›€</h4>
						<p>"ì—ì„¸ì´ êµ¬ì¡°ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”", "í”„ë¡œì íŠ¸ ì•„ì´ë””ì–´ê°€ í•„ìš”í•´ìš”"</p>
					</div>
				</div>
			</Card>
		</div>
	</main>
</div>

<style>
	.maice-page {
		min-height: 100vh;
		background: var(--maice-bg-primary);
		color: var(--maice-text-primary);
	}

	.maice-header {
		background: var(--maice-bg-card);
		border-bottom: 1px solid var(--maice-border-primary);
		padding: 1rem 0;
		position: sticky;
		top: 0;
		z-index: 100;
		backdrop-filter: blur(10px);
	}

	.maice-container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 1rem;
	}

	.maice-header .maice-container {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.maice-header-left {
		display: flex;
		align-items: center;
		gap: 1rem;
	}

	.maice-title {
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--maice-text-primary);
		margin: 0;
	}

	.maice-header-right {
		display: flex;
		align-items: center;
		gap: 1rem;
	}

	.maice-user-info {
		font-size: 0.875rem;
		color: var(--maice-text-secondary);
	}

	.maice-username {
		font-weight: 600;
		color: var(--maice-text-primary);
	}

	.maice-main {
		padding: 2rem 0;
	}

	/* ì„¸ì…˜ ê´€ë¦¬ ì‚¬ì´ë“œë°” */
	.maice-session-sidebar {
		position: fixed;
		left: 1rem;
		top: 50%;
		transform: translateY(-50%);
		width: 320px;
		max-height: 80vh;
		z-index: 200;
	}

	.maice-session-card {
		height: 100%;
		max-height: 80vh;
		overflow: hidden;
	}

	/* ì„¸ì…˜ ì •ë³´ */
	.maice-session-info {
		display: flex;
		gap: 2rem;
		padding: 1rem;
		background: var(--maice-bg-secondary);
		border: 1px solid var(--maice-border-secondary);
		border-radius: 0.5rem;
		margin-bottom: 1rem;
		font-size: 0.875rem;
	}

	.maice-session-item {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.maice-session-label {
		font-weight: 600;
		color: var(--maice-text-secondary);
	}

	.maice-session-value {
		font-family: 'Courier New', monospace;
		color: var(--maice-text-primary);
	}

	.maice-session-null {
		color: var(--maice-text-tertiary);
		font-style: italic;
	}

	.maice-session-active {
		color: #10b981;
		font-weight: 600;
	}

	.maice-session-inactive {
		color: var(--maice-text-tertiary);
	}

	/* ì‚¬ìš© íŒ */
	.maice-tips-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 1.5rem;
	}

	.maice-tip {
		text-align: center;
		padding: 1rem;
	}

	.maice-tip h4 {
		font-size: 1.125rem;
		font-weight: 600;
		color: var(--maice-text-primary);
		margin: 0 0 0.75rem 0;
	}

	.maice-tip p {
		font-size: 0.875rem;
		color: var(--maice-text-secondary);
		margin: 0;
		line-height: 1.5;
	}

	/* ë°˜ì‘í˜• ë””ìì¸ */
	@media (max-width: 768px) {
		.maice-header .maice-container {
			flex-direction: column;
			gap: 1rem;
		}
		
		.maice-header-left {
			flex-direction: column;
			gap: 0.5rem;
		}
		
		.maice-title {
			font-size: 1.25rem;
		}
		
		.maice-tips-grid {
			grid-template-columns: 1fr;
		}
	}
</style>
